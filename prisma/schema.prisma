generator client {
  provider      = "prisma-client"
  output        = "../generated/prisma"
  moduleFormat  = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  USER
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?  @db.Text
  access_token             String?  @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?  @db.Text
  session_state            String?
  refresh_token_expires_in Int?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  password      String?
  emailVerified DateTime?

  role Role @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resetToken       String?
  resetTokenExpiry DateTime?

  accounts   Account[]
  sessions   Session[]
  workspaces WorkspaceMember[]
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  members  WorkspaceMember[]
  chatbots Chatbot[]
}

model WorkspaceMember {
  id   String        @id @default(cuid())
  role WorkspaceRole @default(MEMBER)

  userId      String
  workspaceId String

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ShapeType {
  ROUND
  SQUARE
  ROUNDED_SQUARE
}

enum BorderType {
  FLAT
  ROUND
  ROUNDED_FLAT
}

model Chatbot {
  id          String  @id @default(cuid())
  name        String
  description String?
  suggestions String[]

  theme String?

  icon        String?
  iconSize    Int?
  iconColor   String?
  iconShape   ShapeType  @default(ROUND)
  iconBorder  BorderType @default(FLAT)
  iconBgColor String?

  avatar        String?
  avatarSize    Int?
  avatarColor   String?
  avatarBorder  BorderType @default(FLAT)
  avatarBgColor String?

  popup_onload Boolean @default(false)

  greeting  String @default("Hi there! How can I help you today?")
  directive String @db.Text

  model       String @default("meta-llama/Llama-3.3-70B-Instruct-Turbo")
  max_tokens  Int    @default(500)
  temperature Float  @default(0.7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  form           LeadForm?
  leads          Lead[]
  conversations  Conversation[]
  knowledgeBases KnowledgeBase[]
  logics         Logic[]
  documentVectors DocumentVector[]

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

enum LeadTiming {
  BEGINNING
  MIDDLE
  END
}

enum LeadFormStyle {
  EMBEDDED
  MESSAGES
}

model Lead {
  id   String @id @default(cuid())
  data Json

  formId String
  form   LeadForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  conversationId String?       @unique
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([formId])
  @@index([chatbotId])
  @@index([conversationId])
}

model LeadForm {
  id          String  @id @default(cuid())
  title       String  @default("Get started")
  description String?

  fields        Json
  leadTiming    LeadTiming    @default(BEGINNING)
  leadFormStyle LeadFormStyle @default(EMBEDDED)

  chatbotId String  @unique
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads Lead[]

  @@index([chatbotId])
}

enum SenderType {
  USER
  BOT
}

model Conversation {
  id        String  @id @default(cuid())
  title     String?
  chatbotId String
  userId    String?
  leadId    String?

  isActive Boolean @default(true)
  metadata Json?
  summary  String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endedAt   DateTime?

  chatbot  Chatbot   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  messages Message[]
  lead     Lead?

  @@index([chatbotId])
  @@index([userId])
  @@index([isActive])
  @@index([createdAt])
  @@index([leadId])
}

model Message {
  id         String     @id @default(cuid())
  content    String     @db.Text
  senderType SenderType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([senderType])
}

model KnowledgeBase {
  id         String   @id @default(cuid())
  chatbotId  String
  name       String
  type       KBType
  autoUpdate Boolean  @default(false)
  indexName  String
  createdAt  DateTime @default(now())

  chatbot   Chatbot    @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  documents Document[]
  documentVectors DocumentVector[]
}

model Document {
  id              String   @id @default(cuid())
  knowledgeBaseId String
  source          String   @unique
  content         String   @db.Text
  metadata        Json
  createdAt       DateTime @default(now())

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  documentVectors DocumentVector[]

  @@index([source])
}

enum KBType {
  PRODUCT
  PAGE
  FAQ
  DOC
}

model Logic {
  id        String    @id @default(cuid())
  chatbotId String
  type      LogicType

  // Basic info
  name        String
  description String?

  // Configuration data
  config Json

  // Activation rules
  triggerType   TriggerType @default(KEYWORD)
  keywords      String[]    @db.Text
  showAlways    Boolean     @default(false)
  showAtEnd     Boolean     @default(false)
  showOnButton  Boolean     @default(false)
  triggerConfig Json?

  // Status
  isActive Boolean @default(true)
  position Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chatbot         Chatbot          @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  linkButton      LinkButton?
  meetingSchedule MeetingSchedule?
  leadCollection  LeadCollection?
}

model LinkButton {
  id      String @id @default(cuid())
  logicId String @unique

  buttonText   String
  buttonIcon   String?
  buttonLink   String
  openInNewTab Boolean @default(true)

  // Styling options
  buttonColor String?    @default("#3b82f6")
  textColor   String?    @default("#ffffff")
  buttonSize  ButtonSize @default(MEDIUM)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logic Logic @relation(fields: [logicId], references: [id], onDelete: Cascade)
}

model MeetingSchedule {
  id      String @id @default(cuid())
  logicId String @unique

  calendarType CalendarType @default(CALENDLY)
  calendarLink String
  calendarId   String?

  // Meeting options
  duration    Int?    @default(30)
  timezone    String? @default("UTC")
  titleFormat String? @default("Meeting with {company}")
  description String? @db.Text

  // Availability settings
  availabilityDays  String? @db.Text
  availabilityHours String? @db.Text
  bufferTime        Int?    @default(5)

  // Display options
  showTimezoneSelector Boolean @default(true)
  requireConfirmation  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logic Logic @relation(fields: [logicId], references: [id], onDelete: Cascade)
}

model LeadCollection {
  id      String @id @default(cuid())
  logicId String @unique

  formTitle String  @default("Get Started")
  formDesc  String? @db.Text

  leadTiming    LeadTiming    @default(BEGINNING)
  leadFormStyle LeadFormStyle @default(EMBEDDED)
  cadence       Cadence       @default(ALL_AT_ONCE)

  fields     String  @db.Text
  fieldOrder String? @db.Text

  successMessage String? @db.Text
  redirectUrl    String?
  autoClose      Boolean @default(true)
  showThankYou   Boolean @default(true)

  notifyEmail String?
  webhookUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logic      Logic       @relation(fields: [logicId], references: [id], onDelete: Cascade)
  formFields FormField[]
}

model FormField {
  id               String @id @default(cuid())
  leadCollectionId String

  type            FieldType
  label           String
  required        Boolean   @default(true)
  placeholder     String?
  defaultValue    String?
  validationRules String?   @db.Text

  // For select/radio/checkbox fields
  options String? @db.Text

  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadCollection LeadCollection @relation(fields: [leadCollectionId], references: [id], onDelete: Cascade)

  @@index([leadCollectionId])
  @@index([order])
}

enum LogicType {
  COLLECT_LEADS
  LINK_BUTTON
  SCHEDULE_MEETING
  ZAPIER_INTEGRATION
  SUGGESTIONS
  CUSTOM_ACTION
}

enum TriggerType {
  KEYWORD
  ALWAYS
  MANUAL
  END_OF_CONVERSATION
  MESSAGE_COUNT
  TIME_DELAY
}

enum ButtonSize {
  SMALL
  MEDIUM
  LARGE
}

enum CalendarType {
  CALENDLY
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  CUSTOM
}

enum Cadence {
  ALL_AT_ONCE
  ONE_BY_ONE
  GROUPED
}

enum FieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  CURRENCY
  DATE
  LINK
  SELECT
  RADIO
  CHECKBOX
  TEXTAREA
  MULTISELECT
}

// Vector storage model for PostgreSQL pgvector extension
model DocumentVector {
  id              String   @id @default(cuid())
  documentId      String
  knowledgeBaseId String
  chatbotId       String
  chunkIndex      Int
  content         String   @db.Text
  embedding       Unsupported("vector(768)")? // pgvector type
  metadata        Json
  createdAt       DateTime @default(now())

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  document      Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  chatbot       Chatbot       @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([chatbotId])
  @@index([knowledgeBaseId])
  @@index([documentId])
  @@index([createdAt])
}