generator client {
  provider      = "prisma-client"
  output        = "../generated/prisma"
  moduleFormat  = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  USER
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?  @db.Text
  access_token             String?  @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?  @db.Text
  session_state            String?
  refresh_token_expires_in Int?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  password      String?
  emailVerified DateTime?

  role Role @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resetToken       String?
  resetTokenExpiry DateTime?

  accounts   Account[]
  sessions   Session[]
  workspaces WorkspaceMember[]
  sentWorkspaceInvitations WorkspaceInvitation[] @relation("SentWorkspaceInvitations")
  acceptedWorkspaceInvitations WorkspaceInvitation[] @relation("AcceptedWorkspaceInvitations")
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  members      WorkspaceMember[]
  invitations  WorkspaceInvitation[] // Added this
  chatbots     Chatbot[]
}

model WorkspaceMember {
  id   String        @id @default(cuid())
  role WorkspaceRole @default(MEMBER)

  userId      String
  workspaceId String

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  invitations WorkspaceInvitation[] @relation("MemberInvitations") // Added relation name

  @@unique([userId, workspaceId])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ShapeType {
  ROUND
  SQUARE
  ROUNDED_SQUARE
}

enum BorderType {
  FLAT
  ROUND
  ROUNDED_FLAT
}

model Chatbot {
  id          String  @id @default(cuid())
  name        String
  description String?
  suggestions String[]

  theme String?

  icon        String?
  iconSize    Int?
  iconColor   String?
  iconShape   ShapeType  @default(ROUND)
  iconBorder  BorderType @default(FLAT)
  iconBgColor String?

  avatar        String?
  avatarSize    Int?
  avatarColor   String?
  avatarBorder  BorderType @default(FLAT)
  avatarBgColor String?

  popup_onload Boolean @default(false)

  greeting  String @default("Hi there! How can I help you today?")
  directive String @db.Text

  model       String @default("meta-llama/Llama-3.3-70B-Instruct-Turbo")
  max_tokens  Int    @default(500)
  temperature Float  @default(0.7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Each chatbot has only one form and one logic configuration
  form           ChatbotForm?
  logic          ChatbotLogic?
  
  leads          Lead[]
  conversations  Conversation[]
  knowledgeBases KnowledgeBase[]
  documentVectors DocumentVector[]

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model ChatbotForm {
  id          String  @id @default(cuid())
  title       String  @default("Get started")
  description String?

  // Form fields configuration
  fields        Json // Array of form field objects
  
  // Form behavior
  leadTiming    LeadTiming    @default(BEGINNING)
  leadFormStyle LeadFormStyle @default(EMBEDDED)
  cadence       Cadence       @default(ALL_AT_ONCE)
  
  // Form settings
  successMessage String? @default("Thank you! We'll be in touch soon.")
  redirectUrl    String?
  autoClose      Boolean @default(true)
  showThankYou   Boolean @default(true)
  
  // Notifications
  notifyEmail String?
  webhookUrl  String?
  
  // 1:1 relationship with Chatbot
  chatbotId String  @unique
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads Lead[]

  @@index([chatbotId])
}

// Consolidated Logic model - each chatbot has only one logic configuration
model ChatbotLogic {
  id        String    @id @default(cuid())
  
  // Basic info
  name        String  @default("Chatbot Logic")
  description String? @default("Logic configuration for this chatbot")
  
  // General settings
  isActive    Boolean @default(true)
  
  // Lead collection configuration (moved from LeadCollection)
  leadCollectionEnabled Boolean @default(false)
  leadCollectionConfig  Json?   // Contains all lead collection settings
  
  // Link button configuration (moved from LinkButton)
  linkButtonEnabled Boolean @default(false)
  linkButtonConfig  Json?   // Contains all link button settings
  
  // Meeting schedule configuration (moved from MeetingSchedule)
  meetingScheduleEnabled Boolean @default(false)
  meetingScheduleConfig  Json?   // Contains all meeting schedule settings
  
  // Trigger configurations
  triggers Json? // Array of trigger configurations
  
  // 1:1 relationship with Chatbot
  chatbotId String @unique
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatbotId])
}

enum LeadTiming {
  BEGINNING
  MIDDLE
  END
}

enum LeadFormStyle {
  EMBEDDED
  MESSAGES
}

model Lead {
  id   String @id @default(cuid())
  data Json

  formId String
  form   ChatbotForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  conversationId String?       @unique
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([formId])
  @@index([chatbotId])
  @@index([conversationId])
}

enum SenderType {
  USER
  BOT
}

model Conversation {
  id        String  @id @default(cuid())
  title     String?
  chatbotId String
  userId    String?
  leadId    String?

  isActive Boolean @default(true)
  metadata Json?
  summary  String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endedAt   DateTime?

  chatbot  Chatbot   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  messages Message[]
  lead     Lead?

  @@index([chatbotId])
  @@index([userId])
  @@index([isActive])
  @@index([createdAt])
  @@index([leadId])
}

model Message {
  id         String     @id @default(cuid())
  content    String     @db.Text
  senderType SenderType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([senderType])
}

model KnowledgeBase {
  id         String   @id @default(cuid())
  chatbotId  String
  name       String
  type       KBType
  autoUpdate Boolean  @default(false)
  indexName  String
  createdAt  DateTime @default(now())

  chatbot   Chatbot    @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  documents Document[]
  documentVectors DocumentVector[]
}

model Document {
  id              String   @id @default(cuid())
  knowledgeBaseId String
  source          String   @unique
  content         String   @db.Text
  metadata        Json
  createdAt       DateTime @default(now())

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  documentVectors DocumentVector[]

  @@index([source])
}

enum KBType {
  PRODUCT
  PAGE
  FAQ
  DOC
}

enum TriggerType {
  KEYWORD
  ALWAYS
  MANUAL
  END_OF_CONVERSATION
  MESSAGE_COUNT
  TIME_DELAY
}

enum ButtonSize {
  SMALL
  MEDIUM
  LARGE
}

enum CalendarType {
  CALENDLY
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  CUSTOM
}

enum Cadence {
  ALL_AT_ONCE
  ONE_BY_ONE
  GROUPED
}

enum FieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  CURRENCY
  DATE
  LINK
  SELECT
  RADIO
  CHECKBOX
  TEXTAREA
  MULTISELECT
}

// Vector storage model for PostgreSQL pgvector extension
model DocumentVector {
  id              String   @id @default(cuid())
  documentId      String
  knowledgeBaseId String
  chatbotId       String
  chunkIndex      Int
  content         String   @db.Text
  embedding       Unsupported("vector(768)")? // pgvector type
  metadata        Json
  createdAt       DateTime @default(now())

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  document      Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  chatbot       Chatbot       @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([chatbotId])
  @@index([knowledgeBaseId])
  @@index([documentId])
  @@index([createdAt])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
  REJECTED
}

model WorkspaceInvitation {
  id           String           @id @default(cuid())
  workspaceId  String
  workspace    Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  status       InvitationStatus @default(PENDING)
  token        String           @unique
  role         WorkspaceRole    @default(MEMBER)
  expiresAt    DateTime
  
  invitedById  String
  invitedBy    User             @relation(fields: [invitedById], references: [id], onDelete: Cascade, name: "SentWorkspaceInvitations")
  invitedToId  String?
  invitedTo    User?             @relation(fields: [invitedToId], references: [id], onDelete: Cascade, name: "AcceptedWorkspaceInvitations")

  email        String?

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Added relation to WorkspaceMember
  memberId     String?
  member       WorkspaceMember? @relation(fields: [memberId], references: [id], onDelete: SetNull, name: "MemberInvitations")

  @@unique([workspaceId, invitedToId, status])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@index([invitedById])
  @@index([invitedToId])
  @@index([workspaceId, invitedToId, status])
  @@index([memberId])
}